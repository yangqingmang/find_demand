# 配置加密系统使用指南

## 概述

本项目实现了一套基于 RSA + AES 混合加密的配置管理系统，可以安全地将敏感配置（如 API 密钥）加密后提交到版本控制系统，同时支持多种密钥管理方式。

## 系统特点

### 🔐 混合加密
- **RSA 2048位**：用于加密 AES 密钥
- **AES 256位**：用于加密实际配置数据
- **安全性高**：结合了非对称和对称加密的优势

### 🔑 混合密钥管理
支持多种私钥获取方式（按优先级）：
1. **本地文件**：`config/private.key`（开发环境推荐）
2. **环境变量**：`RSA_PRIVATE_KEY`（CI/CD 环境推荐）
3. **交互输入**：临时使用时手动输入

### 📁 分层配置
- **加密配置**：`.env.encrypted`（敏感信息，可提交）
- **公开配置**：`.env.public`（非敏感信息，可提交）
- **私钥文件**：`private.key`（绝不提交）

## 快速开始

### 1. 安装依赖

```bash
python install_crypto_deps.py
```

### 2. 初始化加密系统

```bash
# 生成密钥对
python config/crypto_manager.py
```

这将生成：
- `config/private.key`：私钥（本地保存，不提交）
- `config/public.key`：公钥（可以提交）

### 3. 迁移现有配置

如果你已有 `.env` 文件：

```bash
python config/migrate_config.py
```

系统会自动：
- 识别敏感配置（API 密钥等）并加密
- 保留公开配置为明文
- 备份原始文件

### 4. 验证配置

```bash
python config/config_manager.py
```

## 详细使用

### 配置文件结构

```
config/
├── private.key          # RSA私钥（不提交）
├── public.key           # RSA公钥（可提交）
├── .env.encrypted       # 加密的敏感配置（可提交）
├── .env.public          # 公开配置（可提交）
└── .gitignore           # 忽略敏感文件
```

### 敏感配置项

以下配置会被自动加密：
- `GOOGLE_API_KEY`
- `GOOGLE_CSE_ID`
- `GOOGLE_ADS_DEVELOPER_TOKEN`
- `GOOGLE_ADS_CLIENT_ID`
- `GOOGLE_ADS_CLIENT_SECRET`
- `GOOGLE_ADS_REFRESH_TOKEN`
- `GOOGLE_ADS_CUSTOMER_ID`
- `SERP_API_KEY`
- `AHREFS_API_KEY`

### 公开配置项

以下配置保持明文：
- `SERP_CACHE_ENABLED`
- `SERP_CACHE_DURATION`
- `SERP_REQUEST_DELAY`
- `SERP_MAX_RETRIES`
- `DEBUG`
- `LOG_LEVEL`
- `OUTPUT_DIR`

## 命令行工具

### 配置加密工具

```bash
# 加密配置文件
python config/encrypt_config.py encrypt .env -o .env.encrypted

# 解密配置文件
python config/encrypt_config.py decrypt .env.encrypted -o .env.decrypted

# 查看配置信息
python config/encrypt_config.py info .env.encrypted
```

### 配置迁移工具

```bash
python config/migrate_config.py
```

选项：
1. 迁移现有配置
2. 创建示例配置
3. 验证配置

## 在代码中使用

### 基本用法

```python
from config.config_manager import get_config

# 获取配置
config = get_config()

# 使用配置
api_key = config.GOOGLE_API_KEY
cse_id = config.GOOGLE_CSE_ID
debug_mode = config.DEBUG
```

### 高级用法

```python
from config.config_manager import get_config_manager

manager = get_config_manager()

# 检查配置状态
status = manager.get_config_status()
for name, state in status.items():
    print(f"{name}: {state}")

# 检查特定配置是否已设置
if manager.is_configured('GOOGLE_API_KEY', 'GOOGLE_CSE_ID'):
    print("Google API 配置完整")

# 重新加载配置
config = manager.reload_config()
```

## 团队协作

### 新成员加入流程

1. **获取项目代码**
   ```bash
   git clone <repository>
   cd <project>
   ```

2. **安装依赖**
   ```bash
   python install_crypto_deps.py
   ```

3. **获取私钥**
   - 从团队负责人处获取 `private.key` 文件
   - 保存到 `config/private.key`

4. **验证配置**
   ```bash
   python config/config_manager.py
   ```

### 密钥管理最佳实践

#### 开发环境
- 使用本地文件存储私钥
- 确保 `config/private.key` 不被提交

#### 生产环境
- 使用环境变量传递私钥
- 通过密钥管理服务（如 AWS KMS）管理

#### CI/CD 环境
```yaml
# GitHub Actions 示例
env:
  RSA_PRIVATE_KEY: ${{ secrets.RSA_PRIVATE_KEY }}
```

## 安全注意事项

### ✅ 安全做法
- 私钥文件权限设置为 600
- 定期轮换密钥
- 使用强密码保护私钥（可选）
- 在安全渠道分享私钥

### ❌ 避免的做法
- 将私钥提交到版本控制
- 在不安全渠道传输私钥
- 多个项目共用同一密钥对
- 在日志中输出私钥内容

## 故障排除

### 常见问题

#### 1. 无法加载私钥
```
❌ 无法从任何来源加载私钥
```

**解决方案**：
- 检查 `config/private.key` 是否存在
- 检查环境变量 `RSA_PRIVATE_KEY` 是否设置
- 确认私钥格式正确

#### 2. 解密失败
```
❌ 配置解密失败
```

**解决方案**：
- 确认使用正确的私钥
- 检查加密文件是否损坏
- 重新生成密钥对并重新加密

#### 3. 配置项缺失
```
⚠️ 部分配置缺失，请检查配置文件
```

**解决方案**：
- 检查 `.env.encrypted` 和 `.env.public` 文件
- 运行配置迁移工具
- 手动添加缺失的配置项

### 调试模式

启用详细日志：

```python
import logging
logging.basicConfig(level=logging.DEBUG)

from config.config_manager import get_config
config = get_config()
```

## 更新和维护

### 添加新的敏感配置

1. 编辑 `config/migrate_config.py`
2. 在 `sensitive_keys` 中添加新的配置键
3. 重新运行迁移工具

### 密钥轮换

1. 生成新的密钥对
2. 用新公钥重新加密所有配置
3. 分发新私钥给团队成员
4. 删除旧密钥

```bash
# 备份旧密钥
mv config/private.key config/private.key.old

# 生成新密钥对
python config/crypto_manager.py

# 重新加密配置
python config/migrate_config.py
```

## 技术细节

### 加密流程
1. 生成随机 AES-256 密钥
2. 使用 AES-CBC 模式加密配置数据
3. 使用 RSA-OAEP 加密 AES 密钥
4. 保存加密结果到 JSON 文件

### 解密流程
1. 读取加密的 JSON 文件
2. 使用 RSA 私钥解密 AES 密钥
3. 使用 AES 密钥解密配置数据
4. 解析为配置对象

### 文件格式

#### 加密文件格式 (.env.encrypted)
```json
{
  "encrypted_key": "base64_encoded_rsa_encrypted_aes_key",
  "iv": "base64_encoded_initialization_vector",
  "encrypted_config": "base64_encoded_aes_encrypted_data",
  "algorithm": "RSA-2048 + AES-256-CBC"
}
```

#### 公开配置格式 (.env.public)
```
# 公开配置（非敏感信息）
SERP_CACHE_ENABLED=true
SERP_CACHE_DURATION=3600
DEBUG=false
```

## 总结

这套配置加密系统提供了：
- 🔐 **高安全性**：RSA + AES 混合加密
- 🔧 **易用性**：自动化工具和简单 API
- 🤝 **团队友好**：支持多人协作
- 🚀 **部署友好**：支持多种环境

通过合理使用这套系统，可以在保证安全性的同时，简化配置管理流程。